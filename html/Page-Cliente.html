<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta - Chimbote Travel Tours</title>
    <link rel="stylesheet" href="../css/cliente.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
</head>

<body>
    <header class="client-header">
        <div class="brand">
            <img src="../assets/logo-chimbote.jpg" alt="Logo" class="logo">
            <h1>Chimbote Travel Tours</h1>
        </div>
        <nav class="client-nav">
            <a href="chimbotes.html">Inicio</a>
            <a href="destinos.html">Destinos</a>
            <a href="#" class="active">Mi Cuenta</a>
            <a href="chimbotes.html" class="btn-logout">Cerrar Sesi√≥n</a>
        </nav>
    </header>

    <main class="client-container">
        <aside class="profile-sidebar">
            <div class="profile-card">
                <div class="profile-img">
                    <span class="material-symbols-rounded">account_circle</span>
                </div>
                <h2 id="profile-name">Juan P√©rez</h2>
                <p>Cliente</p>
                <div class="profile-stats">
                    <div class="stat">
                        <span class="count" id="completed-trips-count">0</span>
                        <span class="label">Viajes</span>
                    </div>
                    <div class="stat">
                        <span class="count" id="active-reservations-count">0</span>
                        <span class="label">Reservas</span>
                    </div>
                </div>
            </div>
            <nav class="profile-nav">
                <ul>
                    <li><a href="#mis-reservas" class="active"><span
                                class="material-symbols-rounded">airplane_ticket</span> Mis Reservas</a></li>
                    <li><a href="#mis-datos"><span class="material-symbols-rounded">person</span> Mis Datos</a></li>
                    <li><a href="#historial"><span class="material-symbols-rounded">history</span> Historial</a></li>
                </ul>
            </nav>
        </aside>

        <section class="content-area">
            <div id="mis-reservas" class="tab-content active">
                <h2>Mis Reservas</h2>
                <div class="reservations-list">
                    <!-- Reservas se cargan din√°micamente -->
                </div>
            </div>

            <div id="mis-datos" class="tab-content" style="display: none;">
                <h2>Mis Datos Personales</h2>
                <form class="profile-form">
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <input type="text" id="input-name" value="Juan P√©rez" disabled>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="input-email" value="juan.perez@email.com" disabled>
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="tel" value="+51 987 654 321">
                    </div>
                    <button type="button" class="btn-primary">Guardar Cambios</button>
                </form>
            </div>
            <div id="historial" class="tab-content" style="display: none;">
                <h2>Historial de Todas las Reservas</h2>
                <div class="all-reservations-list">
                    <!-- Todas las reservas se cargan din√°micamente -->
                </div>
            </div>
        </section>
    </main>

    <!-- Modal de Detalles -->
    <div id="detailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeDetailsModal()">&times;</span>
            <div id="modalBody">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>

    <script>
        // Cargar datos del usuario y reservas
        document.addEventListener('DOMContentLoaded', () => {
            const storedUser = JSON.parse(localStorage.getItem('user'));
            console.log('Stored user:', storedUser);

            if (storedUser) {
                // El backend devuelve 'username' no 'fullname'
                if (storedUser.username) {
                    document.getElementById('profile-name').textContent = storedUser.username;
                    document.getElementById('input-name').value = storedUser.username;
                }
                if (storedUser.email) {
                    document.getElementById('input-email').value = storedUser.email;
                    // Cargar reservas del usuario
                    loadUserReservations(storedUser.email);
                    // Cargar estad√≠sticas del usuario
                    loadUserStats(storedUser.email);
                }
            } else {
                console.log('No user data found in localStorage');
            }
        });

        // Cargar estad√≠sticas del usuario
        async function loadUserStats(email) {
            try {
                const response = await fetch(`http://localhost:3002/api/reservations/by-email/${email}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    // Contar viajes completados
                    const completedTrips = result.data.filter(r => r.status === 'completed').length;

                    // Contar reservas activas (pending, confirmed)
                    const activeReservations = result.data.filter(r =>
                        r.status === 'pending' || r.status === 'confirmed'
                    ).length;

                    // Actualizar en la UI
                    document.getElementById('completed-trips-count').textContent = completedTrips;
                    document.getElementById('active-reservations-count').textContent = activeReservations;
                } else {
                    // Si no hay reservas, dejar en 0
                    document.getElementById('completed-trips-count').textContent = '0';
                    document.getElementById('active-reservations-count').textContent = '0';
                }
            } catch (error) {
                console.error('Error loading user stats:', error);
            }
        }

        // Cargar reservas del usuario (solo activas, no canceladas)
        async function loadUserReservations(email) {
            try {
                const response = await fetch(`http://localhost:3002/api/reservations/by-email/${email}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    // Filtrar solo reservas NO canceladas
                    const activeReservations = result.data.filter(r => r.status !== 'cancelled');

                    if (activeReservations.length > 0) {
                        displayReservations(activeReservations);
                    } else {
                        showNoReservationsMessage();
                    }
                } else {
                    showNoReservationsMessage();
                }
            } catch (error) {
                console.error('Error loading reservations:', error);
                showErrorMessage();
            }
        }

        // Mostrar reservas
        function displayReservations(reservations) {
            const container = document.querySelector('.reservations-list');
            container.innerHTML = ''; // Limpiar reservas de ejemplo

            reservations.forEach(reservation => {
                const card = createReservationCard(reservation);
                container.appendChild(card);
            });
        }

        // Crear tarjeta de reserva
        function createReservationCard(reservation) {
            const card = document.createElement('div');
            card.className = 'reservation-card';

            // Determinar si es futura o pasada
            const travelDate = new Date(reservation.travel_date);
            const today = new Date();
            const isPast = travelDate < today;

            if (isPast) {
                card.classList.add('past');
            } else {
                card.classList.add('upcoming');
            }

            // Formatear fecha
            const formattedDate = travelDate.toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });

            // Mapear status a espa√±ol
            const statusMap = {
                'pending': 'Pendiente',
                'confirmed': 'Confirmada',
                'cancelled': 'Cancelada',
                'completed': 'Completada'
            };

            card.innerHTML = `
                <div class="res-header">
                    <span class="status ${reservation.status}">${statusMap[reservation.status] || 'Pendiente'}</span>
                    <span class="date">${formattedDate}</span>
                </div>
                <div class="res-body">
                    <h3>${reservation.destination_name}</h3>
                    <p><span class="material-symbols-rounded">schedule</span> ${reservation.duration_days} D√≠a${reservation.duration_days > 1 ? 's' : ''}</p>
                    <p><span class="material-symbols-rounded">group</span> ${reservation.number_of_people} Persona${reservation.number_of_people > 1 ? 's' : ''}</p>
                    <p class="price">S/ ${parseFloat(reservation.total_price).toFixed(2)}</p>
                </div>
                <div class="res-footer">
                    <button class="btn-outline" onclick="showReservationDetails(${reservation.id})">Ver Detalles</button>
                </div>
            `;

            return card;
        }

        // Mostrar mensaje de sin reservas
        function showNoReservationsMessage() {
            const container = document.querySelector('.reservations-list');
            container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No tienes reservas a√∫n. <a href="reserva1.html" style="color: #00695c; font-weight: bold;">Haz tu primera reserva</a></p>';
        }

        // Mostrar mensaje de error
        function showErrorMessage() {
            const container = document.querySelector('.reservations-list');
            container.innerHTML = '<p style="text-align: center; padding: 40px; color: #e74c3c;">Error al cargar las reservas. Por favor intenta nuevamente.</p>';
        }

        // Mostrar detalles de reserva
        async function showReservationDetails(reservationId) {
            try {
                const response = await fetch(`http://localhost:3002/api/reservations/${reservationId}`);
                const result = await response.json();

                if (result.success) {
                    const reservation = result.data;
                    displayDetailsModal(reservation);
                }
            } catch (error) {
                console.error('Error loading reservation details:', error);
                alert('Error al cargar los detalles de la reserva');
            }
        }

        // Mostrar modal con detalles
        function displayDetailsModal(reservation) {
            const modalBody = document.getElementById('modalBody');

            // Formatear includes
            let includesList = '';
            if (reservation.includes && Array.isArray(reservation.includes)) {
                includesList = reservation.includes.map(item => `<li>${item}</li>`).join('');
            }

            // Formatear fecha
            const travelDate = new Date(reservation.travel_date);
            const formattedDate = travelDate.toLocaleDateString('es-ES', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });

            // Mapear status a espa√±ol
            const statusMap = {
                'pending': 'Pendiente',
                'confirmed': 'Confirmada',
                'cancelled': 'Cancelada',
                'completed': 'Completada'
            };

            modalBody.innerHTML = `
                <h2>${reservation.destination_name}</h2>
                <img src="${reservation.image_url || '/assets/logo-chimbote.jpg'}" alt="${reservation.destination_name}" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; margin-bottom: 20px;">
                
                <div class="detail-section">
                    <h3>üìç Informaci√≥n del Destino</h3>
                    <p><strong>Ubicaci√≥n:</strong> ${reservation.location}</p>
                    <p><strong>Descripci√≥n:</strong> ${reservation.description || 'No disponible'}</p>
                    <p><strong>Duraci√≥n:</strong> ${reservation.duration_days} d√≠a${reservation.duration_days > 1 ? 's' : ''}</p>
                    <p><strong>Precio por persona:</strong> S/ ${parseFloat(reservation.destination_price).toFixed(2)}</p>
                </div>

                ${includesList ? `
                <div class="detail-section">
                    <h3>‚úì Incluye</h3>
                    <ul class="includes-list">${includesList}</ul>
                </div>
                ` : ''}

                <div class="detail-section">
                    <h3>üé´ Detalles de tu Reserva</h3>
                    <p><strong>Fecha de viaje:</strong> ${formattedDate}</p>
                    <p><strong>N√∫mero de personas:</strong> ${reservation.number_of_people}</p>
                    <p><strong>Total a pagar:</strong> <span style="color: #27ae60; font-size: 1.2em; font-weight: bold;">S/ ${parseFloat(reservation.total_price).toFixed(2)}</span></p>
                    <p><strong>Estado:</strong> <span class="status ${reservation.status}">${statusMap[reservation.status] || 'Pendiente'}</span></p>
                </div>

                <div class="detail-section" style="border-bottom: none; padding-bottom: 0;">
                    <h3>‚ö° Acciones</h3>
                    <div style="display: flex; gap: 15px; margin-top: 15px;">
                        <button onclick="showPaymentMethods(${reservation.id})" class="btn-primary" style="flex: 1;">üí≥ Pagar</button>
                        <button onclick="deleteReservation(${reservation.id})" class="btn-outline" style="flex: 1; border-color: #e74c3c; color: #e74c3c;">üóëÔ∏è Borrar Pedido</button>
                    </div>
                </div>
            `;

            document.getElementById('detailsModal').style.display = 'block';
        }

        // Mostrar m√©todos de pago
        function showPaymentMethods(reservationId) {
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <h2>üí≥ M√©todos de Pago</h2>
                <p style="text-align: center; margin-bottom: 30px;">Selecciona tu m√©todo de pago preferido:</p>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px;">
                    <a href="visa.html" style="text-decoration: none;">
                        <div style="border: 2px solid #eee; border-radius: 10px; padding: 20px; text-align: center; transition: all 0.3s; cursor: pointer;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5e/Visa_Inc._logo.svg/1200px-Visa_Inc._logo.svg.png" alt="Visa" style="width: 100%; max-width: 120px; height: 40px; object-fit: contain;">
                        </div>
                    </a>
                    <a href="mastercard.html" style="text-decoration: none;">
                        <div style="border: 2px solid #eee; border-radius: 10px; padding: 20px; text-align: center; transition: all 0.3s; cursor: pointer;">
                            <img src="https://e7.pngegg.com/pngimages/962/794/png-clipart-mastercard-credit-card-mastercard-logo-mastercard-logo-love-text.png" alt="Mastercard" style="width: 100%; max-width: 120px; height: 40px; object-fit: contain;">
                        </div>
                    </a>
                    <a href="yape.html" style="text-decoration: none;">
                        <div style="border: 2px solid #eee; border-radius: 10px; padding: 20px; text-align: center; transition: all 0.3s; cursor: pointer;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/0/08/Icono_de_la_aplicaci%C3%B3n_Yape.png" alt="Yape" style="width: 100%; max-width: 120px; height: 40px; object-fit: contain;">
                        </div>
                    </a>
                    <a href="plin.html" style="text-decoration: none;">
                        <div style="border: 2px solid #eee; border-radius: 10px; padding: 20px; text-align: center; transition: all 0.3s; cursor: pointer;">
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTo9ig-yw4ZC6cj896X8Fl3DSd160deJD-dFw&s" alt="Plin" style="width: 100%; max-width: 120px; height: 40px; object-fit: contain;">
                        </div>
                    </a>
                </div>
                
                <div style="text-align: center;">
                    <button onclick="closeDetailsModal()" class="btn-outline">Volver</button>
                </div>
            `;
        }

        // Borrar reserva
        async function deleteReservation(reservationId) {
            if (!confirm('¬øEst√°s seguro de que deseas borrar esta reserva?')) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:3002/api/reservations/${reservationId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: 'cancelled' })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Reserva cancelada exitosamente');
                    closeDetailsModal();
                    // Recargar reservas
                    const storedUser = JSON.parse(localStorage.getItem('user'));
                    if (storedUser && storedUser.email) {
                        loadUserReservations(storedUser.email);
                    }
                } else {
                    alert('Error al cancelar la reserva: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cancelar la reserva');
            }
        }

        // Cargar todas las reservas del cliente para el historial (incluyendo canceladas)
        async function loadAllReservations() {
            const storedUser = JSON.parse(localStorage.getItem('user'));
            if (!storedUser || !storedUser.email) {
                showNoHistoryMessage();
                return;
            }

            try {
                const response = await fetch(`http://localhost:3002/api/reservations/by-email/${storedUser.email}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    displayAllReservations(result.data);
                } else {
                    showNoHistoryMessage();
                }
            } catch (error) {
                console.error('Error loading all reservations:', error);
                showHistoryErrorMessage();
            }
        }

        // Mostrar todas las reservas en historial
        function displayAllReservations(reservations) {
            const container = document.querySelector('.all-reservations-list');
            container.innerHTML = '';

            reservations.forEach(reservation => {
                const card = createReservationCard(reservation);
                container.appendChild(card);
            });
        }

        // Mensajes para historial
        function showNoHistoryMessage() {
            const container = document.querySelector('.all-reservations-list');
            container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No tienes historial de reservas.</p>';
        }

        function showHistoryErrorMessage() {
            const container = document.querySelector('.all-reservations-list');
            container.innerHTML = '<p style="text-align: center; padding: 40px; color: #e74c3c;">Error al cargar el historial.</p>';
        }

        // Cerrar modal
        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function (event) {
            const modal = document.getElementById('detailsModal');
            if (event.target == modal) {
                closeDetailsModal();
            }
        }

        // Navegaci√≥n entre tabs
        document.querySelectorAll('.profile-nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);

                // Update active link
                document.querySelectorAll('.profile-nav a').forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                // Show content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                    content.classList.remove('active');
                });

                const targetContent = document.getElementById(targetId);
                if (targetContent) {
                    targetContent.style.display = 'block';
                    setTimeout(() => targetContent.classList.add('active'), 10);

                    // Cargar todas las reservas si es el historial
                    if (targetId === 'historial') {
                        loadAllReservations();
                    }
                }
            });
        });
    </script>
</body>

</html>