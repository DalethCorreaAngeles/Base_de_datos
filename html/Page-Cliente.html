<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Cuenta - Chimbote Travel Tours</title>
    <link rel="stylesheet" href="../css/cliente.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
</head>

<body>
    <header class="client-header">
        <div class="brand">
            <img src="../assets/logo-chimbote.jpg" alt="Logo" class="logo">
            <h1>Chimbote Travel Tours</h1>
        </div>
        <nav class="client-nav">
            <a href="chimbotes.html">Inicio</a>
            <a href="destinos.html">Destinos</a>
            <a href="#" class="active">Mi Cuenta</a>
            <a href="chimbotes.html" class="btn-logout">Cerrar Sesión</a>
        </nav>
    </header>

    <main class="client-container">
        <aside class="profile-sidebar">
            <div class="profile-card">
                <div class="profile-img">
                    <span class="material-symbols-rounded">account_circle</span>
                </div>
                <h2 id="profile-name">Juan Pérez</h2>
                <p>Cliente</p>
                <div class="profile-stats">
                    <div class="stat">
                        <span class="count" id="completed-trips-count">0</span>
                        <span class="label">Viajes</span>
                    </div>
                    <div class="stat">
                        <span class="count" id="active-reservations-count">0</span>
                        <span class="label">Reservas</span>
                    </div>
                </div>
            </div>
            <nav class="profile-nav">
                <ul>
                    <li><a href="#mis-reservas" class="active"><span
                                class="material-symbols-rounded">airplane_ticket</span> Mis Reservas</a></li>
                    <li><a href="#mis-datos"><span class="material-symbols-rounded">person</span> Mis Datos</a></li>
                    <li><a href="#historial"><span class="material-symbols-rounded">history</span> Historial</a></li>
                </ul>
            </nav>
        </aside>

        <section class="content-area">
            <div id="mis-reservas" class="tab-content active">
                <h2>Mis Reservas</h2>
                <div class="reservations-list">
                    <!-- Reservas se cargan dinámicamente -->
                </div>
            </div>

            <div id="mis-datos" class="tab-content" style="display: none;">
                <h2>Mis Datos Personales</h2>
                <form class="profile-form">
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <input type="text" id="input-name" value="Juan Pérez" disabled>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="input-email" value="juan.perez@email.com" disabled>
                        </div>
                        <div class="form-group">
                            <label>Teléfono</label>
                            <input type="tel" id="input-phone" value="+51 987 654 321" />
                        </div>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>País</label>
                            <input type="text" id="input-pais" placeholder="Ej. Perú" />
                        </div>
                        <div class="form-group">
                            <label>Fecha de Nacimiento</label>
                            <input type="date" id="input-fecha_nacimiento" />
                        </div>
                    </div>
                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label>Tipo de Documento</label>
                            <select id="input-tipo_documento"
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="" disabled selected>Seleccione</option>
                                <option value="DNI">DNI</option>
                                <option value="Pasaporte">Pasaporte</option>
                                <option value="Carne extranjeria">Carné de Extranjería</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Número de Documento</label>
                            <input type="text" id="input-numero_documento" placeholder="Ingrese su número" />
                        </div>
                    </div>
                    <button type="button" class="btn-primary" id="save-phone-btn">Guardar Cambios</button>
                </form>
            </div>
            <div id="historial" class="tab-content" style="display: none;">
                <h2>Historial de Todas las Reservas</h2>
                <div class="all-reservations-list">
                    <!-- Todas las reservas se cargan dinámicamente -->
                </div>
            </div>
        </section>
    </main>

    <!-- Modal de Detalles -->
    <div id="detailsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeDetailsModal()">&times;</span>
            <div id="modalBody">
                <!-- Contenido dinámico -->
            </div>
        </div>
    </div>

    <script>
        // Cargar datos del usuario y reservas
        document.addEventListener('DOMContentLoaded', () => {
            const storedUser = JSON.parse(localStorage.getItem('user'));
            console.log('Stored user:', storedUser);

            if (storedUser) {
                // El backend devuelve 'username' no 'fullname'
                if (storedUser.username) {
                    document.getElementById('profile-name').textContent = storedUser.username;
                    document.getElementById('input-name').value = storedUser.username;
                }
                if (storedUser.email) {
                    document.getElementById('input-email').value = storedUser.email;
                    // Cargar reservas del usuario
                    loadUserReservations(storedUser.email);
                    // Cargar estadísticas del usuario
                    loadUserStats(storedUser.email);

                    // Cargar otros datos
                    if (storedUser.phone) document.getElementById('input-phone').value = storedUser.phone;
                    if (storedUser.pais) document.getElementById('input-pais').value = storedUser.pais;
                    if (storedUser.tipo_documento) document.getElementById('input-tipo_documento').value = storedUser.tipo_documento;
                    if (storedUser.numero_documento) document.getElementById('input-numero_documento').value = storedUser.numero_documento;
                    if (storedUser.fecha_nacimiento) {
                        // Formatear fecha para input date (YYYY-MM-DD)
                        const date = new Date(storedUser.fecha_nacimiento);
                        const formattedDate = date.toISOString().split('T')[0];
                        document.getElementById('input-fecha_nacimiento').value = formattedDate;
                    }
                }
            } else {
                console.log('No user data found in localStorage');
                // Redirigir a login si no hay usuario?
                // window.location.href = 'login.html';
            }

            // Tab Switching Logic
            const navLinks = document.querySelectorAll('.profile-nav a');
            const tabContents = document.querySelectorAll('.tab-content');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();

                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    // Add active class to clicked link
                    link.classList.add('active');

                    // Hide all tab contents
                    tabContents.forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });

                    // Show target tab content
                    const targetId = link.getAttribute('href').substring(1); // remove #
                    const targetContent = document.getElementById(targetId);
                    if (targetContent) {
                        targetContent.style.display = 'block';
                        targetContent.classList.add('active');
                    }
                });
            });
        });

        async function loadUserReservations(email) {
            try {
                const response = await fetch(`http://localhost:3000/api/reservations/by-email/${email}`);
                const result = await response.json();

                const container = document.querySelector('.reservations-list');
                const historyContainer = document.querySelector('.all-reservations-list');

                container.innerHTML = '';
                if (historyContainer) historyContainer.innerHTML = '';

                if (result.success && result.data.length > 0) {
                    result.data.forEach(reservation => {
                        const card = createReservationCard(reservation);
                        container.appendChild(card);

                        // For now, history is the same as reservations
                        if (historyContainer) {
                            const historyCard = createReservationCard(reservation);
                            historyContainer.appendChild(historyCard);
                        }
                    });
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <p>No tienes reservas activas. <a href="destinos.html" style="color: #007bff; text-decoration: underline;">Hacer mi primera reserva</a></p>
                        </div>
                    `;
                    if (historyContainer) historyContainer.innerHTML = '<p>No tienes historial de reservas.</p>';
                }
            } catch (error) {
                console.error('Error loading reservations:', error);
                document.querySelector('.reservations-list').innerHTML = '<p>Error al cargar reservas.</p>';
            }
        }

        async function loadUserStats(email) {
            try {
                const response = await fetch(`http://localhost:3000/api/reservations/by-email/${email}`);
                const result = await response.json();

                if (result.success) {
                    const reservations = result.data;
                    document.getElementById('active-reservations-count').textContent = reservations.length;

                    // Assuming 'completed' status for trips count, or just total for now
                    const completedTrips = reservations.filter(r => r.status === 'completed').length;
                    document.getElementById('completed-trips-count').textContent = completedTrips;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function createReservationCard(reservation) {
            const div = document.createElement('div');
            div.className = 'reservation-card';
            div.style.border = '1px solid #eee';
            div.style.padding = '15px';
            div.style.marginBottom = '15px';
            div.style.borderRadius = '8px';
            div.style.backgroundColor = '#fff';
            div.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';

            const date = new Date(reservation.travel_date).toLocaleDateString();
            const statusColors = {
                'pending': '#f39c12',
                'confirmed': '#2ecc71',
                'cancelled': '#e74c3c',
                'completed': '#3498db'
            };
            const statusColor = statusColors[reservation.status] || '#95a5a6';

            div.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0; color: #333;">${reservation.destination_name || 'Destino'}</h3>
                    <span style="background-color: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; text-transform: uppercase;">
                        ${reservation.status || 'Pendiente'}
                    </span>
                </div>
                <p style="margin: 5px 0; color: #666;"><strong>Fecha:</strong> ${date}</p>
                <p style="margin: 5px 0; color: #666;"><strong>Personas:</strong> ${reservation.number_of_people}</p>
                <p style="margin: 5px 0; color: #666;"><strong>Total:</strong> $${reservation.total_price}</p>
                <div style="margin-top: 10px; text-align: right;">
                    <button onclick="viewDetails(${reservation.id})" style="background: none; border: 1px solid #3498db; color: #3498db; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Ver Detalles</button>
                </div>
            `;
            return div;
        }

        function viewDetails(id) {
            // Implement modal details view if needed
            console.log('View details for', id);
            // Simple alert for now or implement modal logic
            alert('Detalles de la reserva ' + id);
        }

        // Save profile data
        document.getElementById('save-phone-btn').addEventListener('click', async () => {
            const phone = document.getElementById('input-phone').value.trim();
            const pais = document.getElementById('input-pais').value.trim();
            const tipo_documento = document.getElementById('input-tipo_documento').value;
            const numero_documento = document.getElementById('input-numero_documento').value.trim();
            const fecha_nacimiento = document.getElementById('input-fecha_nacimiento').value;

            const storedUser = JSON.parse(localStorage.getItem('user'));
            if (!storedUser || !storedUser.email) {
                alert('Usuario no autenticado');
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/auth/update-profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: storedUser.email,
                        phone,
                        pais,
                        tipo_documento,
                        numero_documento,
                        fecha_nacimiento
                    })
                });
                const result = await response.json();
                if (result.message) {
                    // Update local storage
                    storedUser.phone = phone;
                    storedUser.pais = pais;
                    storedUser.tipo_documento = tipo_documento;
                    storedUser.numero_documento = numero_documento;
                    storedUser.fecha_nacimiento = fecha_nacimiento;

                    localStorage.setItem('user', JSON.stringify(storedUser));
                    alert(result.message);
                } else if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Respuesta inesperada del servidor');
                }
            } catch (err) {
                console.error('Error updating profile:', err);
                alert('Error al actualizar el perfil');
            }
        });
    </script>
</body>

</html>